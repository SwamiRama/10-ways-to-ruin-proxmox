== Running Docker Directly on the Proxmox Host

It starts innocently enough. You need a quick container for a small
service - maybe a monitoring agent, a reverse proxy, or a simple web
application. Spinning up a whole VM feels like overkill for something so
lightweight. Docker is already familiar, the container image exists, and
installing Docker on the Proxmox host takes just a few commands.

What could possibly go wrong?

As it turns out, quite a lot. And the Proxmox documentation explicitly
warns against this practice for good reasons.

=== Why It's Tempting

The appeal is understandable. Docker containers are lightweight, start
in seconds, and there's an image for practically everything. Compared to
creating a VM, installing an OS, updating packages, and then deploying
your application, pulling a Docker image feels delightfully efficient.

Proxmox is just Debian under the hood, after all. Docker runs fine on
Debian. The installation works, containers start, and everything seems
fine. For days, weeks, maybe even months, you might not notice any
problems.

Then one day your VMs can't reach the network, or the Proxmox firewall
stops working correctly, or you encounter bizarre permission errors that
make no sense. Welcome to the consequences of mixing container runtimes
on your hypervisor.

=== The iptables Conflict

The most common and most frustrating issue involves
https://en.wikipedia.org/wiki/Iptables[iptables], the Linux kernel's
packet filtering framework. Both Proxmox and Docker manipulate iptables
rules to manage network traffic, and they don't coordinate with each
other.

Proxmox uses iptables for its built-in firewall, managing rules that
control traffic to and from VMs and the host itself. Docker also uses
iptables extensively - it creates rules for container networking, port
forwarding, and network isolation between containers.

When both systems modify iptables independently, conflicts are
inevitable. Docker might insert rules that bypass Proxmox's firewall
entirely, exposing services you thought were protected. Proxmox firewall
changes might break Docker networking, leaving containers unable to
communicate. The symptoms vary, but the root cause is the same: two
systems fighting over the same resource.

[%unbreakable]
[source,bash]
----
# Check current iptables rules - you might be surprised what you find
iptables -L -n -v

# Docker adds its own chains
iptables -L DOCKER -n -v
----

After installing Docker, you'll see chains like `DOCKER`, `DOCKER-USER`,
and `DOCKER-ISOLATION` interleaved with Proxmox's rules. Debugging
network issues becomes an exercise in figuring out which system added
which rule and why.

=== Kernel and Namespace Conflicts

Beyond iptables, Docker and Proxmox's virtualization stack can conflict
at deeper levels. Both systems rely heavily on Linux kernel features
like https://en.wikipedia.org/wiki/Linux_namespaces[namespaces] and
https://en.wikipedia.org/wiki/Cgroups[cgroups] for isolation.

Proxmox uses these features to isolate VMs and LXC containers from each
other and from the host. Docker uses the same features for its
containers. While the kernel can technically handle multiple users of
these subsystems, the management layers don't always play nicely
together.

Resource limits set by Proxmox might affect Docker containers in
unexpected ways. Docker's manipulation of cgroups might interfere with
Proxmox's resource accounting. The interactions are complex and often
manifest as strange, hard-to-diagnose behavior rather than clear error
messages.

=== Security Implications

Running Docker on the hypervisor expands your attack surface
significantly. The Proxmox host is the most privileged component in your
infrastructure - compromise it, and an attacker has access to every VM
and container on the system.

Docker containers, despite their isolation, run on the host kernel.
Container escape vulnerabilities, while rare, do exist. Running Docker
directly on your hypervisor means a container escape gives the attacker
control of your entire virtualization infrastructure, not just one VM.

This is why defense in depth matters. When Docker runs inside a VM, a
container escape compromises only that VM. The hypervisor remains
protected by an additional layer of isolation.

Additionally, Docker's default networking model can expose services
unexpectedly. Containers bound to `0.0.0.0` are accessible on all host
interfaces unless you're careful with your iptables rules - which, as we
discussed, are already being fought over by multiple systems.

=== The Upgrade Risk

Proxmox major version upgrades are generally smooth, but they do modify
system components. When you've installed Docker and potentially other
software directly on the host, upgrades become riskier. Package
conflicts, configuration file changes, and dependency issues are all
more likely when the host is running software beyond what Proxmox
expects.

I've seen upgrades fail because Docker's dependencies conflicted with
updated Proxmox packages. Recovering from a failed upgrade on your
hypervisor - with all your VMs inaccessible - is not a fun experience.

Keeping your Proxmox host minimal reduces upgrade risk and makes
troubleshooting easier. When something breaks, you're not wondering
whether it's a Proxmox issue, a Docker issue, or some interaction
between the two.

=== The Right Approach: Docker in a VM

The solution is simple: run Docker in a dedicated VM. The overhead is
minimal with modern virtualization, and the benefits are substantial.

Create a lightweight VM for Docker workloads:

[%unbreakable]
[source,bash]
----
# Create a minimal VM for Docker (via CLI or web interface)
qm create 200 --name docker-host --memory 2048 --cores 2 \
    --net0 virtio,bridge=vmbr0 --scsihw virtio-scsi-single
----

Install your preferred Linux distribution - Debian, Ubuntu, or even a
purpose-built Docker host like https://vmware.github.io/photon/[Photon
OS] - and then install Docker inside that VM.

This approach provides:

*Clean separation* between your hypervisor and your container workloads.
Proxmox manages virtualization; the Docker VM manages containers.

*Independent management* of Docker updates, configuration changes, and
experiments without risking your hypervisor.

*Better security* through an additional isolation layer. Container
escapes stay contained within the VM.

*Easier backups* since the Docker VM can be backed up like any other VM,
capturing all containers and their data in a consistent state.

*Simpler troubleshooting* because you know which system is responsible
for what.

=== What About LXC Containers?

Proxmox's native LXC containers offer another path for lightweight
workloads. LXC containers are more tightly integrated with Proxmox,
avoiding the conflicts that Docker causes.

For applications where an LXC container works well, it's often the
better choice on Proxmox. Many services that you might run in Docker are
also available as LXC templates or can be installed directly in a
minimal LXC container.

[%unbreakable]
[source,bash]
----
# Download and create an LXC container
pveam download local debian-12-standard_12.2-1_amd64.tar.zst
pct create 300 local:vztmpl/debian-12-standard_12.2-1_amd64.tar.zst \
    --hostname my-container --memory 512 --net0 name=eth0,bridge=vmbr0,ip=dhcp
----

However, if you specifically need Docker's ecosystem - the image
library, Docker Compose workflows, or compatibility with container-based
CI/CD pipelines - then a Docker VM is the cleaner solution.

You can even run Docker inside an LXC container. With Proxmox 7+, this
works in unprivileged containers by enabling the `nesting` and `keyctl`
features. However, there are caveats: ZFS-backed containers may need
`fuse-overlayfs` for the Docker storage driver, and backups can be
problematic. A VM remains the safer and more straightforward option.

=== Best Practices

Keep your Proxmox host clean. It should run Proxmox and essential
management tools, nothing more. Resist the temptation to install "`just
one quick thing`" directly on the hypervisor.

Create a dedicated VM for Docker workloads. The resource overhead is
minimal, and the isolation benefits are significant. If you have
multiple Docker use cases with different security requirements, consider
separate VMs rather than mixing everything together.

Use Proxmox's native LXC containers when they fit your needs. They
integrate better with Proxmox's management tools and avoid the conflicts
that Docker introduces.

If you absolutely must run containers directly on the host for some
reason, consider https://podman.io/[Podman] as an alternative to Docker.
Podman is daemonless and rootless by default, avoiding some (though not
all) of the conflicts Docker creates. But even then, a VM is usually the
better choice.

Think of your Proxmox host as infrastructure, not as a general-purpose
server. The more focused its role, the more reliable and maintainable it
becomes.

=== The Bottom Line

Docker on the Proxmox host works until it doesn't, and when it fails,
the problems are frustrating and time-consuming to debug. The
convenience of skipping a VM isn't worth the networking conflicts,
security risks, and upgrade complications.

Take the extra five minutes to create a Docker VM. Your future self, not
debugging iptables rules at midnight, will thank you.

'''''
